<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>mspnp.github.io by mspnp</title>

    <link rel="stylesheet" href="/assets/css/style.css?v=cd52c1ed7315c4bb85659829e9bc2ab9a6d1068d">
    <!--<link rel="stylesheet" href="/assets/css/overrides.css">-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <meta name="viewport" content="width=device-width">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <style>
        .rotate{
            -moz-transition: all 0.5s linear;
            -webkit-transition: all 0.5s linear;
            transition: all 0.5s linear;
        }

        .rotate.down{
            -ms-transform:rotate(90deg);
            -moz-transform:rotate(90deg);
            -webkit-transform:rotate(90deg);
            transform:rotate(90deg);
        }

        .tocLink{
            cursor: pointer;
        }        
        .wrapper1 { width: 860px; margin: 0; }

        blockquote {
            font-size: 12px
        }

    </style>
  </head>
  <body>
    <div class="wrapper1">
      <header>
          <h1>Template Building Blocks</h1>
          <div id="toc"><div class="list-group list-group-root well toc">
  
  <!--<div class="list-group toc">-->
    <div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io">Introduction</div>
    <a href="#toc1" class="list-group-item tocNode" data-toggle="collapse"><span class="glyphicon glyphicon-chevron-right rotate"></span> Building Blocks Version 1</a>
    <div id="toc1" class="collapse list-group">
      <div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io/v1/v1-vnet-n-subnet.html">Virtual Network</div>
      <div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io/v1/v1-networkSecurityGroups.html">Network Security Groups</div>
      <div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io/v1//v1-userDefinedRoutes.html">User Defined Routes</div>
      <div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io/v1/v1-multi-vm-n-nic-m-storage.html">Windows and Linux VMs</div>
      <div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io/v1/v1-virtualMachine-extensions.html">Virtual Machine Extensions</div>
      <div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io/v1/v1-loadBalancer-backend-n-vm.html">Load Balancer</div>
      <div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io/v1/v1-vpn-gateway-vpn-connection.html">VPN</div>
      <div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io/v1//v1-dmz.html">DMZ</div>
    </div>
    
    <a href="#toc2" class="list-group-item tocNode" data-toggle="collapse"><span class="glyphicon glyphicon-chevron-right rotate"></span> Building Blocks Version 2</a>
    <div id="toc2" class="collapse list-group">
      <!--<div class="list-group-item tocLink" link="http://github.com/pages/mspnp/mspnp.github.io/v1-dmz.html">DMZ</div>-->
    </div>
    
  <!--</div> -->

</div></div>
        <!--<h1>mspnp.github.io</h1>
        <p></p>-->

        <!--
          <p class="view"><a href="http://github.com/mspnp/mspnp.github.io">View the Project on GitHub <small></small></a></p>
          
        -->

        <!---->

        <!---->
      </header>
      <section id="content">

      <h1 id="load-balancer">Load Balancer</h1>

<p>Use the loadBalancer-backend-n-vm building block template to deploy an <a href="https://docs.microsoft.com/azure/load-balancer/load-balancer-overview">Azure Load Balancer</a>. This template can also be used to deploy one or more VMs into an availability set.</p>

<p>This building block template supports both public and internal load balancers. You can specify custom load balancer rules, frontend and backend IP pools, <a href="https://docs.microsoft.com/azure/load-balancer/load-balancer-custom-probe-overview">probes</a>, and NAT rules.</p>

<h2 id="parameters">Parameters</h2>

<p>Thre are four parameters in this building block, <strong>loadBalancerSettings</strong>, <strong>virtualMachinesSettings</strong>, <strong>virtualNetworkSettings</strong>, and <strong>buildingBlockSettings</strong>.</p>

<h3 id="loadbalancersettings">loadBalancerSettings</h3>

<p>The <strong>loadBalancerSettings</strong> parameter specifies properties to configure the Azure Load Balancer. It contains the following properties:</p>

<ul>
  <li><strong>name</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of the load balancer.</li>
  <li><strong>frontendIPConfigurations</strong><br />
<em>Array of objects</em>. <em>Required</em>.<br />
Specifies configuration settings for the frontend IP pool. The frontend IP configuration is specified using the following object:
    <ul>
      <li><strong>name</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of the frontend IP pool.</li>
      <li><strong>loadBalancerType</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Valid values: <code class="highlighter-rouge">internal</code> | <code class="highlighter-rouge">public</code><br />
Type of load balancer.</li>
      <li><strong>internalLoadBalancerSettings</strong><br />
<em>Object</em>. <em>Required</em>.<br />
Specifies configuration settings for an internal load balancer. Set to an empty object for public load balancer. The internal load balancer configuration is specified using the following object:
        <ul>
          <li><strong>privateIPAddress</strong><br />
<em>Value</em>. <em>Required</em>.<br />
IP address of the internal load balancer.</li>
          <li><strong>subnetName</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Existing subnet associated with the load balancer’s private IP.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li><strong>loadBalancingRules</strong><br />
<em>Array of objects</em>. <em>Required</em>.<br />
Specifies configuration settings for one or more traffic handling rules. The traffic handling rule is specified using the following object:
    <ul>
      <li><strong>name</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of the rule.</li>
      <li><strong>frontendPort</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Specifies a frontend port on the load balancer to which this rule applies.</li>
      <li><strong>backendPort</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Specifies a port on backend VMs to which the load balancer forwards traffic for this rule.</li>
      <li><strong>protocol</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Valid values: <code class="highlighter-rouge">Tcp</code> | <code class="highlighter-rouge">Udp</code><br />
Specifies the protocol used for the rule.</li>
      <li><strong>backendPoolName</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of the backend IP pool. See <strong>backendPools</strong> for more information.</li>
      <li><strong>frontendIPConfigurationName</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of the frontend IP pool. See <strong>inboundNatRules</strong> for more information.</li>
      <li><strong>enableFloatingIP</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Valid values: <code class="highlighter-rouge">true</code> | <code class="highlighter-rouge">false</code><br />
Set to <code class="highlighter-rouge">true</code> to enable the <strong>backendPort</strong> to be reused for other load balancing rules.</li>
      <li><strong>probeName</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Specifies the name of a health probe used to determine the health of a backend VM. See <strong>probes</strong> for more information.</li>
    </ul>
  </li>
  <li><strong>probes</strong><br />
<em>Array of objects</em>. <em>Required</em>.<br />
Specifies configuration settings for one or more health probes used by the load balancer to determine the health of a backend VM. The health probes are configured using the following object:
    <ul>
      <li><strong>name</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of the health probe. Associate this health probe with a load balancer rule by setting the <strong>probeName</strong> property to it in the <strong>loadBalancingRules</strong> section above.</li>
      <li><strong>port</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Specifies the port number on the backend VM used for the health probe.</li>
      <li><strong>protocol</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Valid values: <code class="highlighter-rouge">Http</code> | <code class="highlighter-rouge">Tcp</code><br />
Protocol used for the health probe.</li>
      <li><strong>requestPath</strong><br />
<em>Value</em>. <em>Required if <strong>protocol</strong> is set to <code class="highlighter-rouge">Http</code>, not used if set to <code class="highlighter-rouge">Tcp</code></em>.<br />
Specifies the HTTP path on a backend VM used for the health probe.</li>
    </ul>
  </li>
  <li><strong>backendPools</strong><br />
<em>Array of Objects</em>. <em>Required</em>.<br />
Specifies configuration settings for a list of backend IP addresses used by the load balancer. The backend pool is configured using the following object:
    <ul>
      <li><strong>name</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of the pool.</li>
      <li><strong>nicIndex</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Each of the backend VMs has one or more NICs. This value specifies the number of the NIC on the VM to which the load balancer will send traffic.</li>
    </ul>
  </li>
  <li><strong>inboundNatRules</strong><br />
<em>Array of objects</em>. <em>Required</em>.<br />
Specifies configuration setting for one or more NAT rules used by the load balancer to direct inbound network traffic. The NAT rules are specified using the following object:
    <ul>
      <li><strong>namePrefix</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of the rule.</li>
      <li><strong>frontendIPConfigurationName</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of a valid frontend pool specified in the <strong>frontendIPConfigurations</strong> section.</li>
      <li><strong>startingFrontendPort</strong><br />
<em>Value</em>. <em>Required if <strong>frontendPort</strong> is not set</em>.<br />
Specifies a starting port number that the NAT rule will map to a backend VM’s port number. The building block template will then increment the port number by one for each VM in the backend pool. For example, if this value is set to <code class="highlighter-rouge">50001</code> and there are two VMs in the backend pool listening on port <code class="highlighter-rouge">3389</code>, the first NAT rule will forward traffic received on port <code class="highlighter-rouge">50001</code> to port <code class="highlighter-rouge">3389</code> on the first VM and will forward traffic received on port <code class="highlighter-rouge">50002</code> to port <code class="highlighter-rouge">3389</code> on the second VM. incrementing this port number for each rule.</li>
      <li><strong>frontendPort</strong><br />
<em>Value</em>. <em>Required if <strong>startingFrontendPort</strong> is not set</em>.<br />
Specifies a port on the load balancer to which this NAT rule applies.</li>
      <li><strong>backendPort</strong><br />
<em>Value</em> <em>Required</em>.<br />
Specifies a port that the VMs in the backend pool listen on for this NAT rule.</li>
      <li><strong>natRuleType</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Valid values: <code class="highlighter-rouge">all</code> | <code class="highlighter-rouge">single</code> | <code class="highlighter-rouge">floatingIP</code><br />
Specifies port reuse on backend VMs. For more information see <a href="https://docs.microsoft.com/azure/load-balancer/load-balancer-multivip-overview">multiple VIPs for Azure load balancer</a>.</li>
      <li><strong>protocol</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Valid values: <code class="highlighter-rouge">Tcp</code> | <code class="highlighter-rouge">Udp</code><br />
Protocol used for this rule.</li>
      <li><strong>vmIndex</strong><br />
<em>Value</em>. <em>Required if <strong>frontendPort</strong> is set, otherwise optional</em>.<br />
The index number of the VM in the backend pool to which this NAT rule applies. Note that this is zero based. The first VM is <strong>vmIndex</strong> <code class="highlighter-rouge">0</code>, the second vm is <strong>vmIndex</strong> <code class="highlighter-rouge">1</code>, and so on.</li>
      <li><strong>nicIndex</strong><br />
<em>Value</em>. <em>Required</em>.<br />
The index number of the NIC on the VM to which this NAT rule applies.</li>
    </ul>
  </li>
</ul>

<h3 id="virtualmachinessettings">virtualMachinesSettings</h3>

<p>The <strong>virtualMachinesSettings</strong> parameter specifies properties for the VMs. For more information on the properties in this section, see the <strong>virtualMachinesSettings</strong> parameter section of the <a href="https://github.com/mspnp/template-building-blocks/blob/v1.0.0/templates/buildingBlocks/multi-vm-n-nic-m-storage/README.md">multi-vm-n-nic-m-storage document</a>.</p>

<h3 id="virtualnetworksettings">virtualNetworkSettings</h3>

<p>The <strong>virtualNetworkSettings</strong> parameter specifies the VNet for the VMs. It contains the following properties:</p>

<ul>
  <li><strong>name</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Name of an existing VNet.</li>
  <li><strong>resourceGroup</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Resource group that the VNet will be created in.</li>
</ul>

<h3 id="buildingblocksettings">buildingBlockSettings</h3>

<p>The <strong>buildingBlockSettings</strong> parameter specifies properties for the deployment. It contains the following properties:</p>

<ul>
  <li><strong>storageAccountsCount</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Number of storage accounts to create.</li>
  <li><strong>vmCount</strong><br />
<em>Value</em>. <em>Required</em>.<br />
Number of VMs to create.</li>
  <li><strong>vmStartIndex</strong><br />
<em>Value</em>. <em>Required</em>.<br />
The starting index of the value that will be added to the <strong>namePrefix</strong> and <strong>computerNamePrefix</strong> names for the VM.</li>
</ul>

<blockquote>
  <p>Note that if there are fewer storage accounts created than VMs, the building block distributes the VMs across the storage accounts as evenly as possible. For example, if you create 2 storage accounts, and 6 VMs, 3 VMs will be deployed to each storage account.</p>
</blockquote>

<h2 id="deployment">Deployment</h2>

<p>You can deploy this building block using the Azure portal, PowerShell, or Azure CLI.</p>

<h3 id="azure-portal">Azure portal</h3>

<p>Note that this building block deployment process requires a parameter file stored in a location with a publicly available URI.</p>

<ol>
  <li>Click the button below:<br /><a href="https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2Fmspnp%2Ftemplate-building-blocks%2Fv1.0.0%2Fscenarios%2FloadBalancer-backend-n-vm%2Fazuredeploy.json" target="_blanK"><img src="http://azuredeploy.net/deploybutton.png" /></a></li>
  <li>Wait for the Azure Portal to open.</li>
  <li>In the <code class="highlighter-rouge">Basics</code> section:
    <ul>
      <li>Select your <code class="highlighter-rouge">Subscription</code> from the drop-down list.</li>
      <li>For the <code class="highlighter-rouge">Resource group</code>, you can either create a new resource group or use an existing resource group.</li>
      <li>Select the region where you’d like to deploy the VNet in the <code class="highlighter-rouge">Location</code> drop-down list.</li>
    </ul>
  </li>
  <li>
    <p>In the <code class="highlighter-rouge">Settings</code> section, enter a URI to a valid parameter file. There are several <a href="https://github.com/mspnp/template-building-blocks/tree/v1.0.0/scenarios/loadBalancer-backend-n-vm/parameters">example parameter files</a> in Github. Note that if you want to use one of these parameter files the URI must be the path to the <code class="highlighter-rouge">raw</code> file in Github. These parameter files require pre-existing VNets and subnets and the deployment will fail if they do not exist. You will need to inspect the parameters to determine these requirements.</p>
  </li>
  <li>Review the terms and conditions, then click the <strong>I agree to the terms and conditions stated above</strong> checkbox.</li>
  <li>Click the <strong>Purchase</strong> button.</li>
  <li>Wait for the deployment to complete.</li>
</ol>

<h3 id="powershell">PowerShell</h3>

<p>To deploy the building block template using a parameter file hosted at a publicly available URI, follow these steps:</p>

<ol>
  <li>Upload your parameter file to a location with a publicly available URI.</li>
  <li>Log in to Azure using your selected subscription:
    <div class="language-powershell highlighter-rouge"><pre class="highlight"><code>Login-AzureRmAccount -SubscriptionId &lt;your subscription ID&gt;
</code></pre>
    </div>
  </li>
  <li>If you do not have an existing resource group, run the <code class="highlighter-rouge">New-AzureRmResourceGroup</code> cmdlet to create one as shown below:
    <div class="language-powershell highlighter-rouge"><pre class="highlight"><code>New-AzureRmResourceGroup -Location &lt;Target Azure Region&gt; -Name &lt;Resource <span class="nb">Group </span>Name&gt; 
</code></pre>
    </div>
  </li>
  <li>Deploy a VNet. For more information see the <a href="https://github.com/mspnp/template-building-blocks/blob/v1.0.0/templates/buildingBlocks/vnet-n-subnet/README.md">vnet-n-subnet</a> building block template.</li>
  <li>Run the <code class="highlighter-rouge">New-AzureRmResourceGroupDeployment</code> cmdlet as shown below.
    <div class="language-powershell highlighter-rouge"><pre class="highlight"><code>New-AzureRmResourceGroupDeployment -ResourceGroupName &lt;Resource <span class="nb">Group </span>Name&gt; -TemplateUri https://raw.githubusercontent.com/mspnp/template-building-blocks/v1.0.0/scenarios/loadBalancer-backend-n-vm/azuredeploy.json -templateParameterUriFromTemplate &lt;URI of parameter file&gt;
</code></pre>
    </div>
  </li>
</ol>

<p><strong>Example</strong></p>

<p>The cmdlet below deploys the <a href="https://raw.githubusercontent.com/mspnp/template-building-blocks/v1.0.0/scenarios/loadBalancer-backend-n-vm/parameters/internal-loadBalancer-multi-backends.parameters.json">internal-loadBalancer-multi-backends</a> parameter file from the <a href="https://github.com/mspnp/template-building-blocks/tree/v1.0.0/scenarios/multi-vm-n-nic-m-storage">scenarios folder</a> in Github.</p>

<blockquote>
  <p>Note that this deployment requires an existing VNet named <strong>bb-dev-vnet</strong> in the <strong>bb-dev-rg</strong> resource group. <strong>bb-dev-vnet</strong> also requires a subnet named <strong>biz</strong>.</p>
</blockquote>

<div class="language-powershell highlighter-rouge"><pre class="highlight"><code>New-AzureRmResourceGroupDeployment -ResourceGroupName bb-dev-rg -TemplateUri https://raw.githubusercontent.com/mspnp/template-building-blocks/v1.0.0/scenarios/loadBalancer-backend-n-vm/azuredeploy.json -templateParameterUriFromTemplate https://raw.githubusercontent.com/mspnp/template-building-blocks/v1.0.0/scenarios/loadBalancer-backend-n-vm/parameters/internal-loadBalancer-multi-backends.parameters.json 
</code></pre>
</div>

<blockquote>
  <p>The parameter files in the scenarios folder include hard-coded administrator usernames and passwords. It is <strong>strongly</strong> recommended that you immediately change the administrator password on the NVA VMs when the deployment is complete.</p>
</blockquote>

<h3 id="azure-cli">Azure CLI</h3>

<p>Before you begin, install the latest version of the <a href="https://docs.microsoft.com/cli/azure/install-azure-cli">Azure CLI</a>.</p>

<p>To deploy the building block template using a parameter file hosted at a publicly available URI, follow these steps:</p>

<ol>
  <li>Upload your parameter file to a location with a publicly available URI.</li>
  <li>Log in to Azure using your selected subscripton:
    <pre><code class="language-batch">az login
</code></pre>
  </li>
  <li>Set your selected subscription:
    <pre><code class="language-batch">az account set --subscription &lt;your subscripton ID&gt;
</code></pre>
  </li>
  <li>If you do not have an existing resource group, create a new one using the following command:
    <pre><code class="language-batch">az group create -l &lt;Target Azure Region&gt; -n &lt;Resource Group Name&gt; 
</code></pre>
  </li>
  <li>Deploy a VNet. For more information see the <a href="https://github.com/mspnp/template-building-blocks/blob/v1.0.0/templates/buildingBlocks/vnet-n-subnet/README.md">vnet-n-subnet</a> building block template.</li>
  <li>Run the command shown below to deploy the VNet
    <pre><code class="language-batch">az group deployment create -g &lt;Resource Group Name&gt; --template-uri https://raw.githubusercontent.com/mspnp/template-building-blocks/v1.0.0/scenarios/multi-vm-n-nic-m-storage/azuredeploy.json --parameters "{\"templateParameterUri\":{\"value\":\"&lt;parameter file public URI&gt;\"}}"
</code></pre>
  </li>
</ol>

<p><strong>Example</strong></p>

<p>The command below deploys the <a href="https://raw.githubusercontent.com/mspnp/template-building-blocks/v1.0.0/scenarios/loadBalancer-backend-n-vm/parameters/internal-loadBalancer-multi-backends.parameters.json">internal-loadBalancer-multi-backends</a> parameter file from the <a href="https://github.com/mspnp/template-building-blocks/tree/v1.0.0/scenarios/loadBalancer-backend-n-vm">scenarios folder</a> in Github.</p>

<blockquote>
  <p>Note that this deployment requires an existing VNet named <strong>bb-dev-vnet</strong> in the <strong>bb-dev-rg</strong> resource group. <strong>bb-dev-vnet</strong> also requires a subnet named <strong>biz</strong>.</p>
</blockquote>

<pre><code class="language-batch">az login
az group deployment create -g bb-dev-rg --template-uri https://raw.githubusercontent.com/mspnp/template-building-blocks/v1.0.0/scenarios/loadBalancer-backend-n-vm/azuredeploy.json --parameters "{\"templateParameterUri\":{\"value\":\"https://raw.githubusercontent.com/mspnp/template-building-blocks/v1.0.0/scenarios/loadBalancer-backend-n-vm/parameters/internal-loadBalancer-multi-backends.parameters.json\"}}"
</code></pre>

<blockquote>
  <p>The parameter files in the scenarios folder include hard-coded administrator usernames and passwords. It is <strong>strongly</strong> recommended that you immediately change the administrator password on the NVA VMs when the deployment is complete.</p>
</blockquote>


      </section>
      <footer>
        
        <p>This project is maintained by <a href="http://github.com/mspnp">mspnp</a></p>
        
      </footer>
    </div>
    <script src="/assets/js/scale.fix.js"></script>

  
    <script>
        $(document).ready(function (){
            $(".tocNode").click(function(){ 
                $(this).children("span").toggleClass("down");
            });
        });
    </script>
    <script>
        $(document).ready(function (){
        $(".tocLink").click(function(){
            $("section[id='content']").load($(this).attr("link") + " section[id='content']");
            });
        });
    </script>
  </body>
</html>